pipeline {
    
    agent none
    // {
             // Run this job within a Docker container built using Dockerfile.build
             // contained within your projects repository. This image should include
             // the core runtimes and dependencies required to run the job,
             // for example Python 3.x and NPM.
            
        //  }

    stages{
        // If you are having issues with your project not getting updated, 
        // try uncommenting the following lines.
        // stage('Checkout'){
        //     steps{
        //     checkout scm
        //     sh 'git submodule update --init --recursive'

        //     }
        // }

        stage('Build') {
            agent {
                docker {
                    FROM python:3
                    ENV PYTHONUNBUFFERED 1
                    WORKDIR /martor_demo/martor_demo/
                    COPY requirements.txt ./
                    RUN pip install -r requirements.txt
                    COPY . /martor_demo/
                    EXPOSE 8000
                    CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"
                }
            }
            steps {
               sh 'pip install --upgrade -r requirements.txt'

            }
        }

        
    
        
        stage('Test') {

            agent {
                docker {
                    image 'qnib/pytest' 
                }
            }
            steps{
                
                // Invoke Django's tests
                sh 'source env/bin/activate && python ./manage.py test'

            }
            
        }

        // stage('Push Image') {
        //     steps{
        //         docker.withRegistry('https://registry.hub.docker.com', 'docker') {
        //             app.push('$(env.BUILD_NUMBER)')
        //             app.push('latest')
        //         }
        //     }
        // }  
    }
}



 
